{% extends 'pam/base.html' %}

{% block content %}
{% csrf_token %}
<style>
    /* Estilos para melhorar a legibilidade no tema escuro */
    .dark-theme label {
        color: #ffffff;
    }
    
    .dark-theme .form-select option {
        background-color: #2d2d2d;
        color: #ffffff;
    }
    
    .dark-theme .card-header h5 {
        color: #ffffff;
    }
    
    .dark-theme .form-check-label {
        color: #ffffff;
    }
    
    .dark-theme .table th,
    .dark-theme .table td {
        color: #ffffff;
    }
    
    .dark-theme .badge {
        color: #ffffff;
    }
    
    .dark-theme p, 
    .dark-theme h1, 
    .dark-theme h5 {
        color: #ffffff;
    }
</style>

<div class="container mt-4">
    <h1 class="mb-4">Gerenciamento de PAs (Estações de Trabalho)</h1>
    
    <div class="row">
        <!-- Formulário para adicionar nova estação de trabalho -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5>Adicionar Nova Estação</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="workstation-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="id_room" class="form-label">Sala</label>
                            <select name="room" id="id_room" class="form-select" required>
                                <option value="">Selecione uma sala</option>
                                {% for room in rooms %}
                                <option value="{{ room.id }}">{{ room.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="id_island" class="form-label">Ilha</label>
                            <select name="island" id="id_island" class="form-select" disabled required>
                                <option value="">Selecione uma sala primeiro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="id_quantity" class="form-label">Quantidade de PAs</label>
                            <input type="number" name="quantity" id="id_quantity" class="form-control" min="1" max="50" value="1" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Adicionar</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Lista de estações de trabalho existentes -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>Estações Existentes</h5>
                </div>
                <div class="card-body">
                    {% if workstations %}
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>PA</th>
                                <th>Setor/PA</th>
                                <th>Funcionário</th>
                                <th>Periféricos</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ws in workstations %}
                            <tr>
                                <td>
                                    {% if ws.sequence %}
                                    PA-{{ ws.sequence }}
                                    {% else %}
                                    PA-S/N
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ws.island %}
                                    {{ ws.get_category_display }}/{{ ws.island.room.name }}-{{ ws.island.name }}
                                    {% else %}
                                    {{ ws.get_category_display }}/-
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ws.employee %}
                                    <div id="employee-{{ ws.id }}" class="d-flex align-items-center">
                                        <span class="me-2">{{ ws.employee.name }}</span>
                                        <button type="button" class="btn btn-sm btn-outline-danger employee-remove" data-ws-id="{{ ws.id }}" title="Remover funcionário">
                                            <i class="bi bi-x"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary ms-1 employee-change" data-ws-id="{{ ws.id }}" data-bs-toggle="modal" data-bs-target="#changeEmployeeModal-{{ ws.id }}" title="Trocar funcionário">
                                            <i class="bi bi-arrow-left-right"></i>
                                        </button>
                                        
                                        <!-- Modal para trocar funcionário -->
                                        <div class="modal fade" id="changeEmployeeModal-{{ ws.id }}" tabindex="-1" aria-labelledby="changeEmployeeModalLabel-{{ ws.id }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="changeEmployeeModalLabel-{{ ws.id }}">Trocar Funcionário da PA-{{ ws.sequence }}</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p>Funcionário atual: <strong>{{ ws.employee.name }}</strong></p>
                                                        <div class="mb-3">
                                                            <label for="newEmployee-{{ ws.id }}" class="form-label">Novo funcionário:</label>
                                                            <select id="newEmployee-{{ ws.id }}" class="form-select">
                                                                <option value="">Selecionar funcionário</option>
                                                                {% for emp in available_employees %}
                                                                <option value="{{ emp.id }}">{{ emp.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                        <button type="button" class="btn btn-primary confirm-employee-change" data-ws-id="{{ ws.id }}" data-bs-dismiss="modal">Confirmar Troca</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div id="employee-{{ ws.id }}">
                                        <select class="form-select form-select-sm employee-select" data-ws-id="{{ ws.id }}">
                                            <option value="">Selecionar funcionário</option>
                                            {% for emp in available_employees %}
                                            <option value="{{ emp.id }}">{{ emp.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ws.monitor %}<span class="badge bg-success">M</span>{% else %}<span class="badge bg-danger">M</span>{% endif %}
                                    {% if ws.keyboard %}<span class="badge bg-success">T</span>{% else %}<span class="badge bg-danger">T</span>{% endif %}
                                    {% if ws.mouse %}<span class="badge bg-success">Mo</span>{% else %}<span class="badge bg-danger">Mo</span>{% endif %}
                                    {% if ws.mousepad %}<span class="badge bg-success">Mp</span>{% else %}<span class="badge bg-danger">Mp</span>{% endif %}
                                    {% if ws.headset %}<span class="badge bg-success">F</span>{% else %}<span class="badge bg-danger">F</span>{% endif %}
                                </td>
                                <td>
                                    <form method="post" action="{% url 'pam:delete_workstation' ws.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Tem certeza que deseja excluir esta estação de trabalho?')">
                                            Excluir
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p>Não há estações de trabalho cadastradas.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const roomSelect = document.getElementById('id_room');
        const islandSelect = document.getElementById('id_island');
        const roomHiddenInput = document.createElement('input');
        
        // Criar o input hidden para o campo room
        roomHiddenInput.type = 'hidden';
        roomHiddenInput.name = 'room';
        roomHiddenInput.id = 'id_room_hidden';
        document.getElementById('workstation-form').appendChild(roomHiddenInput);
        
        // Quando a sala é selecionada, busca as ilhas
        roomSelect.addEventListener('change', function() {
            const roomId = this.value;
            islandSelect.disabled = !roomId;
            
            // Atualiza o campo oculto
            roomHiddenInput.value = roomId;
            
            if (!roomId) {
                islandSelect.innerHTML = '<option value="">Selecione uma sala primeiro</option>';
                return;
            }
            
            // Resetar o select de ilha
            islandSelect.innerHTML = '<option value="">Carregando ilhas...</option>';
            
            fetch(`/get-islands-by-room/${roomId}/`)
                .then(response => response.json())
                .then(data => {
                    islandSelect.innerHTML = '<option value="">Selecione uma ilha</option>';
                    if (data.islands && data.islands.length > 0) {
                        data.islands.forEach(island => {
                            const option = document.createElement('option');
                            option.value = island.id;
                            option.textContent = island.display_name || `Ilha ${island.island_number}`;
                            islandSelect.appendChild(option);
                        });
                        islandSelect.disabled = false;
                    } else {
                        islandSelect.innerHTML = '<option value="">Nenhuma ilha encontrada para esta sala</option>';
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar ilhas:', error);
                    islandSelect.innerHTML = '<option value="">Erro ao carregar ilhas</option>';
                });
        });
        
        // Configurar a atribuição de funcionários por AJAX
        const employeeSelects = document.querySelectorAll('.employee-select');
        employeeSelects.forEach(select => {
            select.addEventListener('change', function() {
                const workstationId = this.getAttribute('data-ws-id');
                const employeeId = this.value;
                
                if (!employeeId) return; // Ignora se nenhum funcionário foi selecionado
                
                // Obter o token CSRF
                const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                
                // Criar objeto FormData para enviar os dados
                const formData = new FormData();
                formData.append('employee_id', employeeId);
                formData.append('csrfmiddlewaretoken', csrfToken);
                
                // Enviar requisição AJAX
                fetch(`/assign-employee/${workstationId}/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Atualizar a interface com o nome do funcionário
                        const employeeContainer = document.getElementById(`employee-${workstationId}`);
                        employeeContainer.innerHTML = `
                            <div class="d-flex align-items-center">
                                <span class="me-2">${data.employee_name}</span>
                                <button type="button" class="btn btn-sm btn-outline-danger employee-remove" data-ws-id="${workstationId}" title="Remover funcionário">
                                    <i class="bi bi-x"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary ms-1 employee-change" data-ws-id="${workstationId}" data-bs-toggle="modal" data-bs-target="#changeEmployeeModal-${workstationId}" title="Trocar funcionário">
                                    <i class="bi bi-arrow-left-right"></i>
                                </button>
                            </div>
                        `;
                        
                        // Adicionar o modal de troca de funcionário
                        const modalHTML = `
                            <div class="modal fade" id="changeEmployeeModal-${workstationId}" tabindex="-1" aria-labelledby="changeEmployeeModalLabel-${workstationId}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="changeEmployeeModalLabel-${workstationId}">Trocar Funcionário da PA</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Funcionário atual: <strong>${data.employee_name}</strong></p>
                                            <div class="mb-3">
                                                <label for="newEmployee-${workstationId}" class="form-label">Novo funcionário:</label>
                                                <select id="newEmployee-${workstationId}" class="form-select">
                                                    <option value="">Selecionar funcionário</option>
                                                    <!-- O conteúdo será preenchido ao abrir o modal -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="button" class="btn btn-primary confirm-employee-change" data-ws-id="${workstationId}" data-bs-dismiss="modal">Confirmar Troca</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.insertAdjacentHTML('beforeend', modalHTML);
                        
                        // Atualizar os eventos
                        updateEmployeeButtons();
                        
                        // Exibir mensagem de sucesso
                        showAlert(data.message, 'success');
                    } else {
                        showAlert(data.error, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Erro ao atribuir funcionário:', error);
                    showAlert('Erro ao comunicar com o servidor.', 'danger');
                });
            });
        });
        
        // Função para atualizar os botões de remoção e troca de funcionário
        function updateEmployeeButtons() {
            // Botões de remover funcionário
            document.querySelectorAll('.employee-remove').forEach(button => {
                button.addEventListener('click', removeEmployee);
            });
            
            // Botões de abrir modal de troca
            document.querySelectorAll('.employee-change').forEach(button => {
                button.addEventListener('click', function() {
                    const workstationId = this.getAttribute('data-ws-id');
                    const modalId = `#changeEmployeeModal-${workstationId}`;
                    const select = document.querySelector(`${modalId} select`);
                    
                    // Buscar funcionários disponíveis para a troca (via AJAX)
                    fetch(`/get-available-employees/?exclude_workstation=${workstationId}`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Limpar opções atuais
                        select.innerHTML = '<option value="">Selecionar funcionário</option>';
                        
                        // Adicionar opções de funcionários
                        if (data.employees && data.employees.length > 0) {
                            data.employees.forEach(emp => {
                                const option = document.createElement('option');
                                option.value = emp.id;
                                option.textContent = emp.name;
                                select.appendChild(option);
                            });
                        } else {
                            select.innerHTML += '<option value="" disabled>Nenhum funcionário disponível</option>';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao buscar funcionários:', error);
                        select.innerHTML = '<option value="">Erro ao carregar funcionários</option>';
                    });
                });
            });
            
            // Confirmar troca de funcionário
            document.querySelectorAll('.confirm-employee-change').forEach(button => {
                button.addEventListener('click', function() {
                    const workstationId = this.getAttribute('data-ws-id');
                    const modalId = `#changeEmployeeModal-${workstationId}`;
                    const select = document.querySelector(`${modalId} select`);
                    const newEmployeeId = select.value;
                    
                    if (!newEmployeeId) {
                        showAlert('Selecione um funcionário para a troca.', 'warning');
                        return;
                    }
                    
                    // Obter o token CSRF
                    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                    
                    // Criar objeto FormData para enviar os dados
                    const formData = new FormData();
                    formData.append('employee_id', newEmployeeId);
                    formData.append('csrfmiddlewaretoken', csrfToken);
                    
                    // Enviar requisição AJAX
                    fetch(`/assign-employee/${workstationId}/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Atualizar o nome do funcionário na interface
                            const employeeSpan = document.querySelector(`#employee-${workstationId} span`);
                            employeeSpan.textContent = data.employee_name;
                            
                            // Exibir mensagem de sucesso
                            showAlert(data.message, 'success');
                        } else {
                            showAlert(data.error, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao trocar funcionário:', error);
                        showAlert('Erro ao comunicar com o servidor.', 'danger');
                    });
                });
            });
        }
        
        // Função para remover funcionário
        function removeEmployee() {
            const workstationId = this.getAttribute('data-ws-id');
            
            // Obter o token CSRF
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            // Criar objeto FormData para enviar os dados
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            // Enviar requisição AJAX
            fetch(`/remove-employee/${workstationId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Atualizar a interface com o dropdown de seleção
                    const employeeContainer = document.getElementById(`employee-${workstationId}`);
                    employeeContainer.innerHTML = `
                        <select class="form-select form-select-sm employee-select" data-ws-id="${workstationId}">
                            <option value="">Selecionar funcionário</option>
                            <!-- O conteúdo será preenchido via AJAX -->
                        </select>
                    `;
                    
                    // Buscar funcionários disponíveis
                    fetch(`/get-available-employees/`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(employeeData => {
                        const select = document.querySelector(`#employee-${workstationId} select`);
                        
                        // Adicionar opções de funcionários
                        if (employeeData.employees && employeeData.employees.length > 0) {
                            employeeData.employees.forEach(emp => {
                                const option = document.createElement('option');
                                option.value = emp.id;
                                option.textContent = emp.name;
                                select.appendChild(option);
                            });
                        }
                        
                        // Reconfigurar o evento de change
                        select.addEventListener('change', function() {
                            const wsId = this.getAttribute('data-ws-id');
                            const empId = this.value;
                            
                            if (!empId) return;
                            
                            // Atribuir funcionário via AJAX (código reutilizado)
                            // ... (código omitido por brevidade, será o mesmo já implementado)
                        });
                    })
                    .catch(error => {
                        console.error('Erro ao buscar funcionários:', error);
                    });
                    
                    // Exibir mensagem de sucesso
                    showAlert(data.message, 'success');
                } else {
                    showAlert(data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Erro ao remover funcionário:', error);
                showAlert('Erro ao comunicar com o servidor.', 'danger');
            });
        }
        
        // Função para exibir alertas
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Remover o alerta após 5 segundos
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Inicializar os botões
        updateEmployeeButtons();
    });
</script>
{% endblock %} 